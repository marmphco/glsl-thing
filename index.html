<html>
   <head>
      <title>GLSL Creator Test</title>
      <script id="test-vertex-shader" type="x-shader/x-vertex" src="default.vsh">
      attribute lowp vec4 iPosition;
      attribute lowp vec4 iNormal;

      varying lowp vec4 vPosition;

        void main(void) {
           vec4 x = iNormal;
           vPosition = iPosition;
           gl_Position = iPosition;
        }
      </script>
      <script id="test-fragment-shader" type="x-shader/x-fragment" src="default.fsh">
        varying lowp vec4 vPosition;
        uniform sampler2D texture0;
        uniform lowp float test;

        void main(void) {
           gl_FragColor = vec4(vPosition.xyz, 1.0) + test * texture2D(texture0, vPosition.xy);
        }
      </script>
      <script type="text/javascript" src="build/glsl-creator.min.js"></script>
   </head>
   <body>
      <h1>GLSL Creator Test</h1>
      <canvas id="canvas" width="640" height="480">It don't load right!</canvas>
      <img id="pusheen" src="pusheen.png" onload="loaded()">

      <script type="text/javascript">
         var canvas = document.getElementById("canvas");
         var context = new GLSLCreator.Context(canvas);

         var gl = context.gl;
         var vertexSource = document.getElementById("test-vertex-shader").firstChild.textContent;
         var fragmentSource = document.getElementById("test-fragment-shader").firstChild.textContent;

         var vshSourceNode = new GLSLCreator.ValueNode(GLSLCreator.PortType.String);
         var fshSourceNode = new GLSLCreator.ValueNode(GLSLCreator.PortType.String);

         var vshNode = new GLSLCreator.ShaderNode(gl, gl.VERTEX_SHADER);
         var fshNode = new GLSLCreator.ShaderNode(gl, gl.FRAGMENT_SHADER);
         vshNode.inputPort("source").bindTo(vshSourceNode.outputPort("value"));
         fshNode.inputPort("source").bindTo(fshSourceNode.outputPort("value"));

         var programNode = new GLSLCreator.ProgramNode(gl);
         programNode.inputPort("vertexShader").bindTo(vshNode.outputPort("shader"));
         programNode.inputPort("fragmentShader").bindTo(fshNode.outputPort("shader"));

         var vertices = new Float32Array([
            0.0, 0.0, 0.0,
            1.0, 0.0, 0.0,
            0.0, 1.0, 0.0,
            1.0, 1.0, 0.0
         ]);
         var indices = new Uint16Array([0, 1, 2, 3]);

         var meshNode = new GLSLCreator.MeshNode(gl, vertices, indices, gl.TRIANGLE_STRIP);

         var renderNode = new GLSLCreator.RenderNode(gl);
         renderNode.inputPort("mesh").bindTo(meshNode.outputPort("mesh"));
         renderNode.inputPort("program").bindTo(programNode.outputPort("program"));

         vshSourceNode.setValue(vertexSource);
         fshSourceNode.setValue(fragmentSource);

         function loaded() {
            setTimeout(function() {
               console.log("IMAGE LOADED");
               var imageNode = new GLSLCreator.ImageNode(gl);
               renderNode.inputPort("texture0").bindTo(imageNode.outputPort("texture"));
               imageNode.setImageData(document.getElementById("pusheen"));
               testImage = imageNode.outputPort("texture").value();
               setTimeout(function() {

               }, 0);

               var testNode = new GLSLCreator.ValueNode(gl.FLOAT);
               renderNode.inputPort("test").bindTo(testNode.outputPort("value"));
               testNode.setValue(0.5);

               test = new Image();
               test.src = GLSLCreator.dataURLWithTexture(gl, testImage);
               document.getElementsByTagName("body")[0].appendChild(test);
            }, 0);
         }
      </script>
   </body>
</html>
